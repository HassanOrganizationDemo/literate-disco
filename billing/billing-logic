Here goes the logic.. 
a very complex one.
